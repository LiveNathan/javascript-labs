<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>7</title>
    <style>
        p {
            font-size: small
        }
    </style>
</head>
<body>
<h1>7</h1>
<h2>Where you are</h2>
<ul>
    <li id="ipAddress">IP Address</li>
    <li id="country">Country</li>
    <li id="countryCode">Country Code</li>
    <li id="countryFlag">Country Flag</li>
    <li id="countryPopulation">Country Population</li>
    <li id="countryArea">Country Area</li>
    <li id="countryLanguage">Country Language</li>
    <li id="countryRegionalBloc">Country Regional Bloc</li>
    <li id="region">Region</li>
    <li id="city">City</li>
    <li id="latitude">Latitude</li>
    <li id="longitude">Longitude</li>
    <li id="timeZone">Time Zone</li>
    <li id="date">Date</li>
    <li id="time">Time</li>
    <li id="timeSunrise">Sunrise</li>
    <li id="timeSunset">Sunset</li>
    <li id="dayLength">Day Length</li>
    <li id="timeSolarNoon">Solar Noon Time</li>
</ul>

<p><a href="https://sunrise-sunset.org/api">Sunset and sunrise times API</a></p>

<script>
    const IPSTACK_ACCESS_KEY = "315c943e1895202bbf4fc8129849e4b4";
    const ipStackPromise = getIpStack();
    const worldTimePromise = getWorldTime();
    const sunPromise = getSun();

    async function getIpStack() {
        try {
            let ipstackResponse = await fetch("http://api.ipstack.com/check?output=json&access_key=" + IPSTACK_ACCESS_KEY);
            let ipstackData = await ipstackResponse.json();
            let ip = ipstackData.ip;
            let country = ipstackData.country_name;
            let countryCode = ipstackData.country_code;
            let countryFlagEmoji = ipstackData.location.country_flag_emoji;
            let region = ipstackData.region_name;
            let city = ipstackData.city;
            let latitude = ipstackData.latitude;
            let longitude = ipstackData.longitude;

            document.getElementById("ipAddress").textContent += ": " + ip;
            document.getElementById("country").textContent += ": " + country;
            document.getElementById("countryCode").textContent += ": " + countryCode;
            document.getElementById("countryFlag").textContent += ": " + countryFlagEmoji;
            document.getElementById("region").textContent += ": " + region;
            document.getElementById("city").textContent += ": " + city;
            document.getElementById("latitude").textContent += ": " + latitude;
            document.getElementById("longitude").textContent += ": " + longitude;

            return {countryCode, latitude, longitude};
        } catch (error) {
            console.error('Error fetching IP Stack:', error);
        }
    }

    getIpStack();

    async function getWorldTime() {
        try {
            let worldTimeResponse = await fetch("http://worldtimeapi.org/api/ip");
            let worldTimeData = await worldTimeResponse.json();
            let timeZone = worldTimeData.timezone;
            let dateObject = new Date(worldTimeData.datetime);
            let formattedDate = dateObject.toLocaleDateString();
            let formattedTime = dateObject.toLocaleTimeString();

            document.getElementById("timeZone").textContent += ": " + timeZone;
            document.getElementById("date").textContent += ": " + formattedDate;
            document.getElementById("time").textContent += ": " + formattedTime;

            return dateObject;
        } catch (error) {
            console.error('Error fetching world time:', error);
        }
    }

    getWorldTime();

    async function getCountries() {
        try {
            const {countryCode} = await ipStackPromise;
            let countriesResponse = await fetch("https://restcountries.com/v3.1/alpha/" + countryCode + "?fields=population");
            let countriesData = await countriesResponse.json();
            let countryPopulation = countriesData.population;

            document.getElementById("countryPopulation").textContent += ": " + countryPopulation;
        } catch (error) {
            console.error('Error fetching country data:', error);
        }
    }

    getCountries();

    async function getSun() {
        try {
            const {latitude, longitude} = await ipStackPromise;
            let sunResponse = await fetch(`https://api.sunrise-sunset.org/json?lat=${latitude}&lng=${longitude}`);
            let sunData = await sunResponse.json();
            let sunResults = sunData.results;
            let sunriseString = sunResults.sunrise;
            let sunriseTime = convertStringToTime(sunResults.sunrise);
            let sunsetString = sunResults.sunset;
            let sunsetTime = convertStringToTime(sunResults.sunset);
            let dayLength = sunResults.day_length;
            let solarNoon = sunResults.solar_noon;
            let solarNoonTime = convertStringToTime(sunResults.solar_noon);


            document.getElementById("timeSunrise").textContent += ": " + sunriseString;
            document.getElementById("timeSunset").textContent += ": " + sunsetString;
            document.getElementById("dayLength").textContent += ": " + dayLength;
            document.getElementById("timeSolarNoon").textContent += ": " + solarNoon;

            return {sunriseTime, sunsetTime, solarNoonTime}
        } catch (error) {
            console.error('Error fetching sun data:', error);
        }
    }
    getSun();

    function convertStringToTime(timeString) {
        const currentTime = new Date();

        let [time, period] = timeString.split(' ');
        let [hours, minutes] = time.split(':');

        hours = hours % 12;
        hours = period.toUpperCase() === 'PM' ? hours + 12 : hours;  // Add 12 hours if period is PM

        currentTime.setHours(hours);
        currentTime.setMinutes(minutes);

        return currentTime;
    }

    async function getSunMultiplier() {
        const {sunriseTime, sunsetTime, solarNoonTime} = await sunPromise;
        const currentTime = await worldTimePromise;

        const sunrise = sunriseTime.getTime();
        const sunset = sunsetTime.getTime();
        const noon = solarNoonTime.getTime();
        const now = currentTime.getTime();

        // Calculate midnight (opposite of solar noon)
        const prevMidnight = noon - 12 * 60 * 60 * 1000;    // midnight of the current day
        const nextMidnight = noon + 12 * 60 * 60 * 1000;    // midnight of the next day

        let multiplier;
        if (now >= sunrise && now <= noon) {
            multiplier = 0.5 + 0.5 * (now - sunrise) / (noon - sunrise);
        } else if (now > noon && now <= sunset) {
            multiplier = 1 - 0.5 * (now - noon) / (sunset - noon);
        } else if (now > sunset && now <= nextMidnight) {
            multiplier = 0.5 - 0.5 * (now - sunset) / (nextMidnight - sunset);
        } else {
            let midnight = now < sunrise ? prevMidnight : nextMidnight;
            multiplier = 0.5 * (now - midnight) / (sunrise - midnight);
        }

        return multiplier;
    }

    document.body.style.background = "-webkit-linear-gradient(top, #FFD700, #FF8C00, #FF0000, #8B0000)";
    document.body.style.background = "-moz-linear-gradient(top, #FFD700, #FF8C00, #FF0000, #8B0000)";
    document.body.style.background = "-o-linear-gradient(top, #FFD700, #FF8C00, #FF0000, #8B0000)";
    document.body.style.background = "linear-gradient(to top, #FFD700, #FF8C00, #FF0000, #8B0000)";

    document.addEventListener('DOMContentLoaded', (event) => {
        setInterval(async function() {
            const multiplier = await getSunMultiplier();
            const overlayColorValue = (1 - multiplier) * 255; // The overlay color is the inverse of the gradient

            // Creating rgba color format for overlay
            const overlayColor = `rgba(0, 0, 0, ${overlayColorValue / 255})`;
            document.body.style.background = `linear-gradient(${overlayColor}, ${overlayColor}), linear-gradient(to top, #8B0000 0%, #FF0000 25%, #FF8C00 50%, #FFD700 100%)`;
        }, 1000);
    });

</script>
</body>
</html>